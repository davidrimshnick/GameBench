#!/usr/bin/env python3
"""Analyze seed games generated by MCTSLite for balance."""

import sys
from pathlib import Path
sys.path.append(str(Path(__file__).parent.parent))

from davechess.data.generator import MCTSLiteAgent, play_game
from davechess.game.state import Player
import numpy as np
import time

def analyze_mcts_games(num_games: int, simulations: int):
    """Generate and analyze MCTSLite games."""
    print(f"\n{'='*60}")
    print(f"Analyzing {num_games} MCTSLite games with {simulations} simulations")
    print(f"{'='*60}")

    agent = MCTSLiteAgent(num_simulations=simulations)

    white_wins = 0
    black_wins = 0
    draws = 0
    game_lengths = []

    start_time = time.time()

    for game_idx in range(num_games):
        if (game_idx + 1) % 10 == 0:
            print(f"  Game {game_idx + 1}/{num_games}...")

        # Play a game with MCTSLite
        moves, winner, turns = play_game(agent, agent, max_moves=200)
        game_lengths.append(len(moves))

        if winner == Player.WHITE:
            white_wins += 1
        elif winner == Player.BLACK:
            black_wins += 1
        else:
            draws += 1

    elapsed = time.time() - start_time

    # Calculate statistics
    total_games = white_wins + black_wins + draws
    white_pct = 100 * white_wins / total_games
    black_pct = 100 * black_wins / total_games
    draw_pct = 100 * draws / total_games
    avg_length = np.mean(game_lengths)
    max_length_games = sum(1 for l in game_lengths if l >= 200)
    balance_score = 1 - abs(white_wins - black_wins) / total_games

    # Print results
    print(f"\nüìä Results:")
    print(f"  White wins: {white_wins:3d} ({white_pct:.1f}%)")
    print(f"  Black wins: {black_wins:3d} ({black_pct:.1f}%)")
    print(f"  Draws:      {draws:3d} ({draw_pct:.1f}%)")
    print(f"  Balance:    {balance_score:.2f} (1.0 = perfect)")

    print(f"\nüìè Game Lengths:")
    print(f"  Average:    {avg_length:.1f} moves")
    print(f"  Min:        {min(game_lengths)} moves")
    print(f"  Max:        {max(game_lengths)} moves")
    print(f"  At 200:     {max_length_games} games ({100*max_length_games/total_games:.1f}%)")

    print(f"\n‚è±Ô∏è  Performance:")
    print(f"  Total time: {elapsed:.1f}s")
    print(f"  Per game:   {elapsed/num_games:.2f}s")

    # Warnings
    if balance_score < 0.6:
        print(f"\n‚ö†Ô∏è  SEVERE IMBALANCE: {max(white_pct, black_pct):.1f}% win rate for one side!")
    if avg_length > 150:
        print(f"‚ö†Ô∏è  Games too long: average {avg_length:.0f} moves")
    if max_length_games > total_games * 0.3:
        print(f"‚ö†Ô∏è  Too many max-length games: {max_length_games}/{total_games}")

    return {
        'white_wins': white_wins,
        'black_wins': black_wins,
        'draws': draws,
        'avg_length': avg_length,
        'balance': balance_score,
        'max_games': max_length_games
    }

def main():
    """Test the exact configurations we're using for seed games."""
    print("Testing seed game configurations from improved training:")

    # These are the exact configs from our improved training
    configs = [
        (30, 10, "Original seeding (30 games @ 10 sims)"),
        (20, 50, "Phase 1 sample (20 games @ 50 sims)"),
        (20, 25, "Phase 2 sample (20 games @ 25 sims)"),
        (10, 100, "Periodic injection (10 games @ 100 sims)"),
    ]

    all_results = []

    for num_games, sims, label in configs:
        print(f"\n{'='*60}")
        print(f"Configuration: {label}")
        results = analyze_mcts_games(num_games, sims)
        all_results.append((label, results))

    # Summary
    print(f"\n{'='*60}")
    print("SUMMARY OF SEED GAME BALANCE")
    print(f"{'='*60}")
    print(f"{'Configuration':<40} {'W%':>6} {'B%':>6} {'D%':>6} {'Len':>6} {'Bal':>6}")
    print("-" * 76)

    for label, res in all_results:
        total = res['white_wins'] + res['black_wins'] + res['draws']
        w_pct = 100 * res['white_wins'] / total
        b_pct = 100 * res['black_wins'] / total
        d_pct = 100 * res['draws'] / total
        print(f"{label:<40} {w_pct:5.1f}% {b_pct:5.1f}% {d_pct:5.1f}% {res['avg_length']:6.1f} {res['balance']:6.2f}")

if __name__ == "__main__":
    main()